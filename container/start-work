#! /bin/bash

set -e -o pipefail

WORKTREE_BASE_DIR=~/src/worktrees
IMAGE_NAME="gh.io/web4application/app-com"
GCP_CREDS_DEFAULT="$HOME/.config/gcloud/application_default_credentials.json"

function usage {
    cat - <<EOF
$0: Start using a coding agent on a git worktree (isolated container)

Usage: $0 [options] [-b <branch_name>] [command...]

Options:
  -b, --branch <name>         Branch name for git worktree
  --gcp-credentials <path>    Path to GCP service account JSON key file
                              (default: ~/.config/gcloud/application_default_credentials.json)
  -h, --help                  Show this help

Arguments:
  command...                  Optional command to execute in the container
                              (container will exit after execution)

Environment Variables:
  ANTHROPIC_API_KEY          Anthropic API key for Claude
  ANTHROPIC_MODEL            Model to use (default: claude-3-5-sonnet-20241022)
  GEMINI_API_KEY             Google Gemini API key
  (See README.md for complete list)

Isolation:
  * Container has NO access to host filesystem except workspace
  * No Docker socket access
  * Configs built into image (not shared with host)
  * Credentials injected at runtime (ephemeral)
  * Cache volume shared across sessions: agent-container-cache

Storage:
  * Worktrees are stored in $WORKTREE_BASE_DIR
  * Cache volume: docker volume ls | grep agent-container-cache
  * Clear cache: docker volume rm agent-container-cache

Examples:
  $0 -b feature-auth                    # Start interactive session
  $0 -b feature-auth -- claude          # Run claude directly
  $0 --gcp-credentials ~/my-sa.json -b feature  # Custom GCP credentials
  $0                                    # Use current directory (no git)
EOF
}

SCRIPT_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

function build_image {
    echo "Building agent container image from $SCRIPT_DIR ..."
    docker build -t "$IMAGE_NAME" -f "$SCRIPT_DIR/Dockerfile" "$SCRIPT_DIR/.."
}

function setup_worktree {
    local worktree_dir="$1"
    local branch_name="$2"
    if [[ -d "$worktree_dir" ]]; then
        echo "Worktree for branch '$branch_name' already exists at $worktree_dir."
    else
        # Check if branch exists
        if git show-ref --verify --quiet "refs/heads/$branch_name"; then
            echo "Adding worktree for existing branch '$branch_name'..."
            git worktree add "$worktree_dir" "$branch_name"
        else
            echo "Creating branch '$branch_name' from current HEAD and adding worktree..."
            git worktree add -b "$branch_name" "$worktree_dir"
        fi
    fi
}

# Parse command line options
BRANCH_NAME=""
CONTAINER_COMMAND=()
USE_GIT=0
GCP_CREDS_PATH=""  # Empty means auto-detect

while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--branch)
            BRANCH_NAME="$2"
            shift 2
            ;;
        --gcp-credentials)
            GCP_CREDS_PATH="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            # All remaining arguments are the command to execute
            CONTAINER_COMMAND=("$@")
            break
            ;;
    esac
done

# Determine if we should use git worktrees
if [[ -n "$BRANCH_NAME" && -d .git ]]; then
    USE_GIT=1
fi

# Ensure the container image is built
build_image

# Create the base directory if it doesn't exist
mkdir -p "$WORKTREE_BASE_DIR"

if [[ "$USE_GIT" == 1 ]]; then
    REPO_NAME="$(basename "$(git rev-parse --show-toplevel)")"
    WORKTREE_DIR="$WORKTREE_BASE_DIR/${REPO_NAME}-${BRANCH_NAME}"
    CONTANIER_NAME="${REPO_NAME}-${BRANCH_NAME}"
    setup_worktree "$WORKTREE_DIR" "$BRANCH_NAME"
else
    echo "Using current directory."
    REPO_NAME="$(basename "$(pwd)")"
    WORKTREE_DIR="$(pwd)"
    CONTANIER_NAME="local-$REPO_NAME"
fi

# Need to make the main repo directory available in the container
if [[ "$USE_GIT" == 1 ]]; then
    MAIN_REPO_DIR=$(awk '{ print $2 }' "${WORKTREE_DIR}/.git")
    MAIN_REPO_DIR="${MAIN_REPO_DIR%%.git*}"
else
    MAIN_REPO_DIR="$(realpath "$(pwd)")"
fi

# Build mount arguments for isolated container
MOUNT_ARGS=(
    "-v" "$WORKTREE_DIR:$WORKTREE_DIR:rw"
    "-v" "agent-container-cache:$HOME/.cache"
)

# Add main repo mount if using git worktrees
if [[ "$USE_GIT" == 1 ]]; then
    MOUNT_ARGS+=("-v" "$MAIN_REPO_DIR:$MAIN_REPO_DIR:rw")
    echo "Mounting worktree: $WORKTREE_DIR (rw)"
    echo "Mounting main repo: $MAIN_REPO_DIR (rw)"
    echo "Mounting cache volume: agent-container-cache"
else
    echo "Mounting current directory: $WORKTREE_DIR (rw)"
    echo "Mounting cache volume: agent-container-cache"
fi

# Handle GCP credential injection
CREDENTIAL_ARGS=()

# Auto-detect if not specified
if [[ -z "$GCP_CREDS_PATH" ]]; then
    GCP_CREDS_PATH="$GCP_CREDS_DEFAULT"
fi

# Inject credentials if file exists
if [[ -f "$GCP_CREDS_PATH" ]]; then
    echo "Injecting GCP credentials from: $GCP_CREDS_PATH"
    GCP_CREDS_B64=$(base64 -w 0 "$GCP_CREDS_PATH")
    CREDENTIAL_ARGS+=("-e" "GCP_CREDENTIALS_B64=$GCP_CREDS_B64")
else
    echo "No GCP credentials file found (checked: $GCP_CREDS_PATH)"
    echo "GCP authentication will rely on environment variables only"
fi

# Start the agent container, mounting the worktree
if [[ ${#CONTAINER_COMMAND[@]} -gt 0 ]]; then
    echo "Starting agent container on $WORKTREE_DIR and executing: ${CONTAINER_COMMAND[*]}"
else
    echo "Starting agent container on $WORKTREE_DIR..."
fi

docker run --rm -it \
    --name "$CONTANIER_NAME" \
    --hostname "$CONTANIER_NAME" \
    "${MOUNT_ARGS[@]}" \
    -w "$WORKTREE_DIR" \
    -e EUID="$(id -u)" \
    -e EGID="$(id -g)" \
    -e HOME="$HOME" \
    -e USER="$USER" \
    "${CREDENTIAL_ARGS[@]}" \
    -e GEMINI_API_KEY \
    -e ANTHROPIC_API_KEY \
    -e ANTHROPIC_MODEL \
    -e ANTHROPIC_SMALL_FAST_MODEL \
    -e ANTHROPIC_VERTEX_PROJECT_ID \
    -e CLOUD_ML_REGION \
    -e CLAUDE_CODE_USE_VERTEX \
    ghcr.io/johnstrunk/agent-container:latest "${CONTAINER_COMMAND[@]}"

# Remove the worktree after exiting the container
if [[ "$USE_GIT" == 1 ]]; then
    git worktree remove "$WORKTREE_DIR" || echo "Not removing worktree $(basename "$WORKTREE_DIR"), it may still be in use."
fi
